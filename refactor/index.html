<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hexbin Maker - Refactored</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/siimple-icons/siimple-icons.css"/>
    <link rel="stylesheet" href="../vendor/leaflet.css" />
    <link rel="stylesheet" href="../vendor/leaflet.draw.css" />
    <link rel="stylesheet" href="../vendor/MarkerCluster.css" />
    <link rel="stylesheet" href="../vendor/MarkerCluster.Default.css" />

    <link rel="icon" type="image/png" href="../og-image.png">

</head>
<body>
    <!-- App Container -->
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">CSV to Hexbin Map</h1>
                <p class="app-subtitle">Create hexagon maps from CSV files with latitude and longitude</p>
            </div>
        </header>

        <!-- Progress Bar -->
        <div class="progress-container hidden">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text">
                Step <span id="current-step">1</span> of <span id="total-steps">5</span>
            </div>
        </div>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Step 1: Start -->
            <section id="step-start" class="step active">
                <div class="step-content">       

                    <div class="start-content">
                        <div class="step-header">
                            <h2>How does it work?</h2>
                            <div class="intro-text">
                                <p>1. Upload a CSV file with latitude/longitude coordinates</p>
                                <p>2. Filter and preview your data</p>
                                <p>3. Select an area of the map for your hexagons</p>
                                <p>4. Generate hexagons with customizable sizes</p>
                                <p>5. Download results as GeoJSON files</p>
                                <p><strong>Done! üéâ</strong><p>
                            </div>
                        </div>


                        <div class="disclaimer">


                            <p>This tool was originally developed at <a href="https://www.dw.com/en/data/t-43091100" target="_blank" class="simple-link">DW's Data Team</a> for visuaizing <a href="https://firms.modaps.eosdis.nasa.gov/active_fire/" target="_blank" class="simple-link">FIRMS</a> data on custom <a href="https://datawrapper.de/" target="_blank" class="simple-link">Datawrapper</a> maps.</p>
                            
                            <p>It was built with lots of help from LLMs and the open source power of <a href="https://siimple.xyz/icons/" target="_blank" class="simple-link">Siimple</a>, <a href="https://turfjs.org/" target="_blank" class="simple-link">Turf.js</a>, <a href="https://leafletjs.com/" target="_blank" class="simple-link">Leaflet</a>, <a href="https://d3js.org/" target="_blank" class="simple-link">D3</a>, <a href="https://h3geo.org/" target="_blank" class="simple-link">H3</a>, and <a href="https://coloris.js.org/" target="_blank" class="simple-link">Coloris.</a></p>
                            
                            <p>This was an experiment at <i>vibe coding</i> and all the recklessness that it entails ‚Äì always check if your data is sound. </p>

                        </div>

                        <div class="step-navigation intro-screen">
                            <button class="nav-button primary" id="start-button">Go ‚Üí</button>
                        </div>
                        


                    </div>

                </div>
                
            </section>

            <!-- Step 2: Upload -->
            <section id="step-upload" class="step">
                <div class="step-content">
                    <div class="step-header">
                        <h2>Upload your CSV</h2>
                        <p>Files must have a <i>latitude</i> and <i>longitude</i> column</p>
                        <p>Maximum 100MB or 500,000 rows</p>
                    </div>
                    
                    <div class="upload-container">
                        <div class="upload-area" id="upload-area">
                            <div class="upload-icon">üìÅ</div>
                            <h3>Drop your file here</h3>
                            <p>or click to browse</p>
                            <input type="file" id="csv-upload" accept=".csv" style="display: none;">
                        </div>
                        
                        <div class="sample-data">
                            <h4>Or try with sample data (<strong>not</strong> updated ‚Äì just for testing)</h4>
                            <select id="sample-csv-select" class="sample-select">
                                <option value="">Select a sample dataset...</option>
                                <option value="../csv-samples/Europe_Fires_VIIRS _7d_20250701.csv">Europe Fires (VIIRS, 7 days)</option>
                                <option value="../csv-samples/J2_VIIRS_C2_Global_48h.csv">Global Fires (VIIRS, 48 hours)</option>
                                <option value="../csv-samples/J2_VIIRS_C2_Global_7d.csv">Global Fires (VIIRS, 7 days)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button class="nav-button secondary" id="back-to-start">‚Üê Back</button>
                    <button class="nav-button primary" id="next-to-filter" disabled>Continue ‚Üí</button>
                </div>
            </section>

            <!-- Step 3: Filter -->
            <section id="step-filter" class="step">
                <div class="step-content">
                    <div class="step-header">
                        <h2>Filter the data</h2>
                        <div class="filter-instructions">
                            <p><strong>Expand any column</strong> to access its filter options. You can filter by categories (select specific values), numbers (set min/max ranges), or dates (choose start/end dates).</p>

                        </div>
                    </div>


                    
                    <div class="filter-container">

                        <!-- Filter control window -->
                        <div class="filter-popup" id="filter-popup" style="display: none;">
                            <div class="filter-popup-header">
                                <h4 id="filter-popup-title">Filter: Column Name</h4>
                                <button class="close-filter-btn" onclick="app.closeFilterPopup()">√ó</button>
                            </div>
                            
                            <div class="filter-popup-content">
                                <div class="filter-type-selector">
                                    <label for="filter-type-selector">Filter Type</label>
                                    <select id="filter-type-selector">
                                        <option value="categorical">Categorical (Select Values)</option>
                                        <option value="numeric">Numeric (Range)</option>
                                        <option value="date">Date (Range)</option>
                                    </select>
                                </div>
                                
                                <div class="filter-content" id="filter-content">
                                    <!-- Filter content will be dynamically generated here -->
                                </div>
                                
                                <div class="filter-popup-actions">
                                    <button class="clear-filter-btn" id="clear-filter-btn">Clear Filter</button>
                                    <button class="apply-filter-btn" id="apply-filter-btn">Apply Filter</button>
                                </div>
                            </div>
                        </div>

                        <!-- Applied filter overview -->
                        <div class="active-filters-container" id="active-filters-container">

                            <h4>Active Filters</h4>
                            <p class="filter-warning">If you are working with fire maps from VIIRS (one of the satellites at FIRMS), remember to filter out low confidence entries in the confidence column!</p>


                            <div class="active-filters-list" id="active-filters-list">
                                <p class="no-filters-message">No filters applied</p>
                            </div>
                        </div>

                        <!-- Data Preview -->
                        <div class="data-preview" id="data-preview">
                            <!-- Data table will be shown here -->
                        </div>
                        

                        <!-- "Showing n rows of ..."-->
                        <div id="preview-info"></div>

                    </div>
                    
                    <!-- Filter Summary -->
                    <div class="filter-summary-container" id="filter-summary-container">
                        <!-- Filter summary will be shown here -->
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button class="nav-button secondary" id="back-to-upload">‚Üê Back</button>
                    <button class="nav-button primary" id="next-to-area" disabled>Continue ‚Üí</button>
                </div>
            </section>

            <!-- Step 4: Area Selection -->
            <section id="step-area" class="step">
                <div class="step-content">
                    <div class="step-header">
                        <h2>Select area</h2>
                        <p>Choose the geographic area for your hexagon map.</p> 
                        <p>Points outside of this area will be excluded from the map.</p>
                    </div>
                    
                    <div class="area-container">
                        <div class="area-controls">
                            <div class="control-group">
                                <h4>Draw a rectangle</h4>
                                <div class="control-info">Click the drawing tools on the map to create a rectangle</div>
                            </div>
                            
                            <div class="control-group">
                                <h4>Upload your GeoJSON</h4>
                                <button class="control-button" id="upload-geojson">Browse...</button>
                                <input type="file" id="geojson-upload" accept=".geojson,.json" style="display: none;">
                            </div>
                            
                            <div class="control-group">
                                <h4>Or select an area from the list</h4>
                                <div class="sample-loader">
                                    <select id="sample-geojson-select" class="sample-select">
                                        <option value="">Select an area...</option>
                                        <option value="../geo-samples/brazil.json">Brazil</option>
                                        <option value="../geo-samples/democratic_congo.json">Democratic Republic of Congo</option>
                                        <option value="../geo-samples/italy.json">Italy</option>
                                        <option value="../geo-samples/japan.json">Japan</option>
                                        <option value="../geo-samples/mexico.json">Mexico</option>
                                        <option value="../geo-samples/ukraine.json">Ukraine</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div id="map" class="area-map"></div>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button class="nav-button secondary" id="back-to-filter">‚Üê Back</button>
                    <button class="nav-button primary" id="next-to-resolution" disabled>Continue ‚Üí</button>
                </div>
            </section>

            <!-- Step 5: Resolution -->
            <section id="step-resolution" class="step">
                <div class="step-content">
                    <div class="step-header">
                        <h2>Choose Resolution and Bin Size</h2>
                        <p>Select the size of your hexagons and preview the results</p>
                    </div>
                    
                    <!-- Main Controls and Preview Section -->
                    <div class="main-controls-preview">
                        <div class="resolution-controls">
                            <div class="control-section">
                                <h4>Select resolution</h4>
                                <p class="control-description">This will control the size of your hexagons. 0 = largest, 15 = smallest</p>
                                
                                <div class="resolution-slider">
                                    <input type="range" id="resolution" min="0" max="15" value="2">
                                    <div class="resolution-info">
                                        <span id="res-value">2</span>
                                        <span id="res-area">(123,930 km¬≤)</span>
                                    </div>
                                </div>
                                
                                <label for="resolution"><strong>Quick reference</strong></label>
                                <div class="resolution-examples">
                                    <div class="example-item">
                                        <span class="example-label">Level 0:</span>
                                        <span class="example-desc">Continental (4.3M km¬≤)</span>
                                    </div>
                                    <div class="example-item">
                                        <span class="example-label">Level 3:</span>
                                        <span class="example-desc">Country (123,930 km¬≤)</span>
                                    </div>
                                    <div class="example-item">
                                        <span class="example-label">Level 6:</span>
                                        <span class="example-desc">City (36 km¬≤)</span>
                                    </div>
                                    <div class="example-item">
                                        <span class="example-label">Level 9:</span>
                                        <span class="example-desc">Neighborhood (0.7 km¬≤)</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="control-section last-control">
                                <h4>Configure binning</h4>
                                <p class="control-description">Define how many bins you want to create and how many points per bin</p>
                                
                                <div class="bin-controls">
                                    <div class="bin-input-wrapper">
                                        <div class="bin-input">
                                            <label for="bin-count">Number of bins</label>
                                            <input type="number" id="bin-count" min="1" max="9999" value="6">
                                        </div>

                                        <div class="bin-input">
                                            <label for="bin-step">Points per bin</label>
                                            <input type="number" id="bin-step" min="1" max="9999" value="5">
                                        </div>

                                    </div>

                                </div>
                            </div>
                        </div>
                        
                        <div class="preview-container">
                            <div class="preview-header">
                                <h4>Preview Map</h4>
                                <p>See your hexagons before downloading</p>
                            </div>
                            <div id="preview-map" class="preview-map"></div>

                            <div class="bin-preview-container control-section last-control">
                                <h4>The map will have the following bins</h4>
                                <p class="control-description">You can change the color legend in the next step</p>
                                <ul class="bin-preview" id="bin-preview">
                                    <!-- Bin preview will be shown here -->
                                </ul>
                            </div>

                        </div>
                    </div>
                    
                    <!-- Histogram Section - Separate from Preview Container -->
                    <div class="histogram-section">
                        <h4>Data Distribution</h4>
                        <p>Visualize how your data is distributed across hexagons.</p> 
                        <p>If the two histograms have very different shapes, consider playing around with the size and number of the bins.</p>
                        <div class="histogram-container" id="histogram-container">
                            <div class="histogram-wrapper">
                                <div class="histogram-section">
                                    <h4 class="histogram-title">How many hexagons have exactly X points?</h4>
                                    <div id="raw-histogram" class="histogram-chart"></div>
                                </div>
                                <div class="histogram-section">
                                    <h4 class="histogram-title">How many hexagons are in each bin?</h4>
                                    <div id="binned-histogram" class="histogram-chart"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="step-navigation">
                    <button class="nav-button secondary" id="back-to-area">‚Üê Back</button>
                    <button class="nav-button primary" id="next-to-download" disabled>Generate Download Files! ‚Üí</button>
                </div>
            </section>

            <!-- Step 6: Download -->
            <section id="step-download" class="step">
                <div class="step-content">
                    <div class="step-header">
                        <h2>Downlod & customize legend</h2>
                        <p>Your hexagon map is ready! You can also customize an HTML color legend to use in Datawrapper</p>
                    </div>
                    
                    <div class="download-container">
                        
                        <div class="preview-container">
                            <div class="preview-header">
                                <h4>Preview map</h4>
                                <p>Your processed hexagon map ready for download</p>
                            </div>
                            <div id="download-preview-map" class="preview-map"></div>
                            
                            <!-- Color Customization Section -->
                            <div class="color-customization">
                                <div class="color-customization-header">
                                    <h5>Customize color legend</h5>
                                    <p>You can change the colors and then copy the HTML legend to use in your Datawrapper map</p>
                                </div>
                                <div id="color-legend" class="color-legend">
                                    <!-- Color legend will be populated here -->
                                </div>
                                <div class="color-controls">
                                    <button id="copy-legend-html" class="copy-legend-btn" title="Copy HTML Legend">
                                        <span><i class="si-copy"></i>Copy HTML legend</span>
                                    </button>
                                    <button id="reset-colors" class="btn btn-outline-secondary btn-sm">
                                        <i class="si-erase"></i> Reset to default colors
                                    </button>

                                </div>

                            </div>
                        </div>

                        <div class="download-info" id="file-info">
                            <div class="info-item">
                                <span class="info-label">Hexagons generated:</span>
                                <span class="info-value" id="hex-count">0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">File size:</span>
                                <span class="info-value" id="file-size">0 KB</span>
                            </div>
                        </div>

                

                        <div class="download-options">

                            <div class="download-option">
                                <h4>Single file</h4>
                                <p>Download all hexagons in one GeoJSON file ‚Äì‚Äì good for making custom Datawrapper choropleth maps</p>
                                <button class="download-button primary" id="download-single">Download single file</button>
                            </div>
                            
                            <div class="download-option">
                                <h4>Multiple files</h4>
                                <p>Download separate files for each bin category ‚Äì‚Äì good for making Datawrapper locator maps</p>
                                <button class="download-button primary" id="download-multi">Download ZIP with multiple files</button>
                            </div>
                        </div>

                        

                    </div>



                </div>
                
                <div class="step-navigation">
                    <button class="nav-button secondary" id="back-to-resolution">‚Üê Go back & adjust</button>
                    <button class="nav-button primary" id="restart-process">Start over</button>
                </div>
            </section>
        </main>
    </div>

    <!-- External Libraries -->
    <script src="../vendor/leaflet.js"></script>
    <script src="../vendor/leaflet.draw.js"></script>
    <script src="../vendor/leaflet.markercluster.js"></script>
    <script src="../vendor/d3.v7.min.js"></script>
    <script src="../vendor/h3-js.umd.js"></script>
    <script src="../vendor/jszip.min.js"></script>
    <script src="../vendor/turf.min.js"></script>
    
    <!-- Coloris Color Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mdbassit/Coloris@latest/dist/coloris.min.css"/>
    <script src="https://cdn.jsdelivr.net/gh/mdbassit/Coloris@latest/dist/coloris.min.js"></script>
    
    <!-- App Scripts -->
    <script src="app.js"></script>
</body>
</html>